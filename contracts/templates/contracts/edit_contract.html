<!-- contracts/templates/contracts/edit_contract.html -->
{% load static %}
{% include "sidebar.html" %}
{% block content %}

<div class="p-4 sm:ml-64">
    <p class="text-2xl m-2 font-semibold tracking-tight leading-none text-black">
        Contract
    </p>
    <div class="container mx-auto p-4">
        <h2 class="text-xl font-semibold mb-6">{{ project.title }}</h2>
        {% for msg in messages %}
            <p>{{ msg }}</p>
        {% endfor %}
        <form method="post" action="{% url 'contracts:edit_contract' contract.id %}" class="space-y-6">
            {% csrf_token %}

            {{ formset.management_form }}

            <!-- Display fixed sections (not editable) -->
            {% for section in fixed_sections %}
            <div class="bg-gray-300 shadow-md rounded-lg p-6 mb-6">
                <div class="border-b border-gray-200 pb-4 mb-4">
                    <h3 class="text-xl font-semibold">{{ section.title }}</h3>
                </div>
                <pre class="whitespace-pre-wrap text-gray-700">{{ section.content }}</pre>
            </div>
            {% endfor %}

            <!-- Display editable sections -->
            {% if not contract.signed_by_client or not contract.signed_by_developer %}
                {% for form in formset %}
                <div class="bg-gray-200 shadow-md rounded-lg p-6 mb-6 editable-section" data-section-id="{{ form.instance.id }}">
                    <div class="border-b border-gray-200 pb-4 mb-4 flex justify-between items-center">
                        <h3 class="text-xl font-semibold">{{ form.instance.title }} (Editable)</h3>
                        <button type="button" class="button bg-blue-600 text-white py-1 px-3 rounded edit-button">Edit</button>
                    </div>
                    <div class="space-y-4 border-gray-500">
                        <div class="read-only-content">
                            {{ form.instance.content|safe }}
                        </div>
                        <div class="edit-content hidden">
                            {{ form.id }}
                            {{ form.content }}
                        </div>
                    </div>
                </div>
                {% endfor %}

                
            {% else %}
                {% for section in contract.sections.all %}
                <div class="bg-gray-300 shadow-md rounded-lg p-6 mb-6">
                    <div class="border-b border-gray-200 pb-4 mb-4">
                        <h3 class="text-xl font-semibold">{{ section.title }}</h3>
                    </div>
                    <pre class="whitespace-pre-wrap text-gray-700">{{ section.content|safe }}</pre>
                </div>
                {% endfor %}
            {% endif %}
            <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                Save All Changes
            </button>
        </form>

    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const editableSections = document.querySelectorAll('.editable-section');

        editableSections.forEach(section => {
            const editButton = section.querySelector('.edit-button');
            const readOnlyContent = section.querySelector('.read-only-content');
            const editContent = section.querySelector('.edit-content');
            const textarea = editContent.querySelector('textarea');
            let editor;

            editButton.addEventListener('click', () => {
                if (editButton.textContent === 'Edit') {
                    readOnlyContent.classList.add('hidden');
                    editContent.classList.remove('hidden');
                    editButton.textContent = 'Cancel';

                    if (!editor) {
                        ClassicEditor
                            .create(textarea)
                            .then(newEditor => {
                                editor = newEditor;
                            })
                            .catch(error => {
                                console.error(error);
                            });
                    }
                } else {
                    readOnlyContent.classList.remove('hidden');
                    editContent.classList.add('hidden');
                    editButton.textContent = 'Edit';
                }
            });
        });
    });
</script>
{% endblock %}